rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthed() { return request.auth != null; }
    function org() { return request.auth.token.orgId; }

    match /orgs/{orgId} {
      allow read, write: if isAuthed() && orgId == org();
    }

    match /orgs/{orgId}/{document=**} {
      allow read, write: if isAuthed() && orgId == org();
    }

    // Global collections with orgId field
    match /{colName}/{docId} where colName in ['contacts','lists','templates','campaigns','campaignSends','sequences','sequenceEnrollments','events'] {
      allow read, write: if isAuthed() && request.resource.data.orgId == org();
    }

    // Public tracking does NOT require auth, but writes only via Functions.
    match /events/{eventId} {
      allow create: if false; // only via Admin SDK
      allow read: if isAuthed() && resource.data.orgId == org();
    }
  }
}